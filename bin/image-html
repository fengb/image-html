#!/usr/bin/env phantomjs


var fs = require('fs');
var sys = require('system');
var page = require('webpage').create();


var file = fs.open(sys.args[1], 'rb');
var imageBase64 = btoa(file.read());
file.close();


function load(dir){
  fs.list(dir).forEach(function(filename){
    var path = dir + '/' + filename;
    if(filename.match(/^\./)){
      //Do nothing
    } else if(fs.isFile(path)){
      page.injectJs(path);
    } else if(fs.isDirectory(path)){
      load(path);
    }
  });
}
load('src');


page.evaluate(function(imageBase64){
  var img = new Image();
  img.onload = function(){
    var out = ImageHtml.dom(img, 'a');
    window.output = {
      css: out.css(),
      html: out.html()
    };
  };
  img.src = 'data:image/png;base64,' + imageBase64;
}, imageBase64);


setInterval(function(){
  var output = page.evaluate(function(){
    return window.output;
  });

  if(output) {
    var outfile = sys.args[2] ? fs.open(sys.args[2], 'w') : sys.stdout;
    outfile.write('<html>\n');
    outfile.write('<head>\n');
    outfile.write('<style>\n');
    outfile.write(output.css);
    outfile.write('</style>\n');
    outfile.write('</head>\n');
    outfile.write('<body>\n');
    outfile.write(output.html);
    outfile.write('</body></html>\n');
    phantom.exit();
  }
}, 100);
